function loadAppConfig(){appConfig=store.get("app-config");var a=null!=appConfig,b=!1;a&&(b=appConfig.version<currentVersion);var c={version:currentVersion,locked:!0,playing:!1,showUI:!1,speed:1,headerFrequency:20,forcedReload:!1,showIndicators:!1};return!(a&&!b)&&(console.log("Reset local storage config!"),store.set("app-config",c),appConfig=store.get("app-config")),appConfig}function saveAppConfig(){store.set("app-config",appConfig)}var socket=io.connect(),appConfig={},currentVersion=.22;loadAppConfig(),$(function(){function a(){if(window.matchMedia){var a=window.matchMedia("only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen  and (min-device-pixel-ratio: 1.3), only screen and (min-resolution: 1.3dppx)");return a&&a.matches||window.devicePixelRatio>1}}function b(){R=$.viewportW(),S=$.viewportH(),S>R?$("#container").removeClass("landscape").addClass("portrait"):$("#container").removeClass("portrait").addClass("landscape");for(var a=0;a<U.length;a++){var b=U[a],c=document.getElementById(b.id);if(null==c);else{K(c,b);var d=O(b),e=L(d);c.style.width=d.width+"px",c.style.height=d.height+"px";var e=L(d);c.style.top=e.y+"px",c.style.left=e.x+"px"}}appConfig.playing||m()}function c(){return{x:W.width()/-2,y:W.height()/-2}}function d(a){var b=a.target;if(l(),!b.getAttribute("data-master"))return void b.classList.remove("dragging");r(b)}function e(a){var a=a||!1;ja=new Date;var b=ja.getTime();if(!(b-ka<la)||a){ka=b,x=parseFloat(W[0].getAttribute("data-x")),y=parseFloat(W[0].getAttribute("data-y"));var c=o({x:x,y:y});appConfig.x=c.x,appConfig.y=c.y,saveAppConfig()}}function f(a){var b=a.target,c=parseFloat(b.getAttribute("data-x"));y=parseFloat(b.getAttribute("data-y")),rotation=parseFloat(b.getAttribute("data-rotation"))||0,b.getAttribute("data-master")||(rotation+=a.da),b.style.webkitTransform=b.style.transform="translateX("+c+"px) translateY( "+y+"px) rotate("+rotation+"deg)",b.setAttribute("data-rotation",rotation),q(a.target)}function g(){if(ja=new Date,currentTime=ja.getTime(),!(currentTime-ma<na)){ma=currentTime;for(var a=document.getElementsByClassName("photo"),b=H(),c=0,d=0;d<a.length;d++){var e=a[d];if(null!=e){var f={x:e.getAttribute("data-x")||0,y:e.getAttribute("data-y")||0},g={x:f.x-b.x,y:f.y-b.y},h=o(g),i=v({x:0,y:0},h),j=i<oa,k=e.classList.contains("hidden");j&&k?e.classList.remove("hidden"):j||k||e.classList.add("hidden"),e.classList.contains("hidden")&&c++}}}}function h(){var a=i("header");null!=a&&a.classList.add("home")}function i(a){var b=!1;if(null!=pa){for(var c=0;c<pa.length;c++){var d=pa[c].element;if(pa[c].target==a){b=!0;break}}if(b)return null;var d=document.createElement("div");d.classList.add("indicator"),d.setAttribute("id",a+"-indicator");return document.body.appendChild(d),pa.push({element:d,target:a,transform:{x:0,y:0}}),l(),d}}function j(a){return null!=a&&(null!=a.parentNode&&(a.parentNode.removeChild(a),!0))}function k(){for(var a=0;a<pa.length;a++)j(pa[a].element);pa=[]}function l(){for(var a=0;a<pa.length;a++){var b=pa[a].element,c=pa[a].target,d=document.getElementById(c);if(null!=d){var e=d.getAttribute("data-x")||0,f=d.getAttribute("data-y")||0,g={x:e,y:f};b.transform=g}}}function m(a){if(appConfig.showIndicators){ja=new Date;var b=ja.getTime();if(!(b-sa<ta)||a){sa=b;for(var c=H(),d=0;d<U.length;d++){var e=U[d],f=e.id,g=(document.getElementById(f),document.getElementById(f+"-indicator"));null==g&&i(f)}null==pa&&(pa=[]);for(var h=0,d=0;d<pa.length;d++){var g=pa[d].element,k=pa[d].target;if(null==document.getElementById(k))j(g)&&pa.splice(pa[d],1);else{var l=g.transform,m={x:l.x-c.x,y:l.y-c.y},n=m.y/m.x,p=o(m),q={x:R/2,y:S/2},r={x:q.x+p.x*R,y:q.y+p.y*S},s=v({x:0,y:0},r);if(s>va||h>ua)g.classList.contains("show")&&g.classList.remove("show");else{h++,g.classList.contains("show")||g.classList.add("show");var n=S/R,t={x:g.left,y:g.top},u=!1,w=!1,x=!1,y=!1;if(r.y<0?(u=!0,t={x:r.x/2/n,y:0}):r.y>S&&(u=!0,y=!0,t={x:r.x/n,y:S}),r.x<0?(w=!0,t={x:0,y:r.y*n*2}):r.x>R&&(w=!0,x=!0,t={x:R,y:r.y*n*2}),t={x:Math.clamp(t.x,0,R),y:Math.clamp(t.y,0,S)},w||u){g.style.top=t.y+"px",g.style.left=t.x+"px",x?g.classList.add("offRight"):g.classList.remove("offRight"),y?g.classList.add("offBottom"):g.classList.remove("offBottom");var z=B(1,.5,s/1e4),A=w||u?B(.8,.25,s/1e4):0;g.style.opacity=A,g.style.transform="scale("+z+")"}else t.x=-1e3,t.y=-1e3,g.style.top=t.y+"px",g.style.left=t.x+"px"}}}}}}function n(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx;if(y=(parseFloat(b.getAttribute("data-y"))||0)+a.dy,rotation=parseFloat(b.getAttribute("data-rotation"))||0,b.getAttribute("data-master")){if(c>R/-2){var d=c-R/-2;c-=d/3}if(c<-Y+R){var d=-Y+R-c;c+=d/3,console.log("right!")}if(y>S/-2){var f=y-S/-2;console.log(S/-2+"top!"),y-=f/3}if(y<-Z+S){var f=-Z+S-c;y-=f/3}}b.style.webkitTransform=b.style.transform="translateX("+c+"px) translateY( "+y+"px) rotate("+rotation+"deg)",b.setAttribute("data-x",c),b.setAttribute("data-y",y),g(),appConfig.locked||q(a.target),appConfig.playing||m(),b.getAttribute("data-master")&&e()}function o(a){var b={width:R,height:S};return{x:a.x/b.width,y:a.y/b.height}}function p(a){var b={width:R,height:S};return{x:b.width*a.x,y:b.height*a.y}}function q(a){if(a.getAttribute("data-update")){var b=a.getAttribute("id")||"null";if("null"==b)return void console.log("Error updating â€” no image id attribute reference.");var c=parseFloat(a.getAttribute("data-x")),d=parseFloat(a.getAttribute("data-y")),e=parseFloat(a.getAttribute("data-rotation"))||0,f=o({x:c,y:d});socket.emit("updateItem",{id:b,props:{x:f.x,y:f.y,rotation:e}})}}function r(a){x=parseFloat(a.getAttribute("data-x")),y=parseFloat(a.getAttribute("data-y")),rotation=parseFloat(a.getAttribute("data-rotation"))||0,$("#container").velocity({translateX:x+"px",translateY:y+"px"},0).attr({"data-x":x,"data-y":y})}function s(a){for(var b=a.getAttribute("id"),c=0,d=0;d<U.length;d++){var e=U[d];e.id!=b&&e.index>c&&(c=e.index)}var f=c+1;console.log("New highest: "+f),socket.emit("updateItem",{id:a.getAttribute("id"),props:{index:f}})}function t(a){appConfig.showUI=a,a?ca.removeClass("hide"):ca.removeClass("hide").addClass("hide"),saveAppConfig()}function u(a){appConfig.locked=a,appConfig.locked?(W.find(".drag-rotate").removeClass("drag-rotate"),da.removeClass("active"),$(".unlocked-only").addClass("hide")):(W.find(".photo").addClass("drag-rotate"),da.addClass("active"),$(".unlocked-only").removeClass("hide")),saveAppConfig()}function v(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}function w(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}function z(){return V.length<1||imageManifestUpdated?(imageManifestUpdated=!1,console.log("Updated shuffled manifest!"),w(U.slice(0))):V}function A(a,b,c){V=z();for(var d=b||2e3,e=100,f=c||0,g=[],h=0;h<V.length;h++){var i=V[h],j=p({x:i.x,y:i.y}),b=v(a,j);b<d&&b>e&&i.id!=wa&&g.push({image:i,index:h,distance:b})}if(f>10)return null;if(0==g.length){f+=1;var k=d+500,l=A(a,k,f);return null==l?null:(wa=l.id,l)}var m=Math.round(Math.random()*(g.length-1)),n=g[m],o=n.image,q=n.index;return wa=n.id,V.splice(q,1),{image:o,distance:n.distance}}function B(a,b,c){return c=c<0?0:c,c=c>1?1:c,a+(b-a)*c}function C(){$(".velocity-animating").velocity("stop",!0)}function D(){if(appConfig.playing){xa++;var a=c();a={x:a.x,y:a.y},relativeTransform=H();var b=A(relativeTransform),d=null==b?null:b.image,f=null==b?1e3:b.distance,h=B(500,15e3,f/1e3),i=null==d||null==b||null==d.delay?6e3:d.delay,j=null==d?{x:0,y:0}:p({x:d.x,y:d.y}),k=null==d?a:{x:a.x-j.x,y:a.y-j.y},l=[];if(null==d||xa>=ba)xa>=ba&&(xa=0),console.log("Returning to center!"),l.push({e:W,p:{translateX:a.x+"px",translateY:a.y+"px"},o:{duration:1e4/appConfig.speed}}),l.push({e:W,p:{scale:1.02},o:{duration:6e3/appConfig.speed,progress:function(){g()},complete:function(){sequenceActive=!1,e(!0),D(),W.attr({"data-x":k.x,"data-y":k.y})}}}),l.push({e:W,p:{scale:1},o:{duration:6e3/appConfig.speed,sequenceQueue:!1}}),$.Velocity.RunSequence(l);else{l.push({e:W,p:{translateX:k.x+"px",translateY:k.y+"px"},o:{duration:h/appConfig.speed,progress:function(){g()},complete:function(){W.attr({"data-x":k.x,"data-y":k.y})}}});var m=document.getElementById(d.id),n=$(m).find("img");l.push({e:n,p:{scale:1.05},o:{duration:i/appConfig.speed,complete:function(){sequenceActive=!1,e(!0),D()}}}),l.push({e:n,p:{scale:1},o:{duration:i/appConfig.speed,sequenceQueue:!1}}),$.Velocity.RunSequence(l)}}}function E(a){a?(W.addClass("commenting"),fa.addClass("active")):(W.removeClass("commenting"),fa.removeClass("active"))}function F(a){a?(W.addClass("removing"),ea.addClass("active")):(W.removeClass("removing"),ea.removeClass("active"))}function G(a){appConfig.playing=a,a?(k(),$("#play-icon").removeClass("active").addClass("active"),appConfig.showUI&&(ra=appConfig.showUI,t(!1)),qa=appConfig.locked,u(!0),W.removeClass("drag"),W.hasClass("velocity-animating")?W.velocity("resume"):D()):(h(),m(),W.hasClass("velocity-animating")&&W.velocity("stop"),$("#play-icon").removeClass("active"),qa&&u(qa),ra&&t(ra),W.addClass("drag")),saveAppConfig()}function H(){var a=c();a={x:a.x,y:a.y};var b=X.style.transform,d=b.match(/-?[\d\.]+/g),e=null==d?[0,0,0]:d;return{x:a.x-e[0],y:a.y-e[1]}}function I(){return currentX=parseFloat(X.getAttribute("data-x")||0),currentY=parseFloat(X.getAttribute("data-y")||0),P({x:currentX,y:currentY})}function J(){for(var a=0;a<U.length;a++){var b=U[a],c=document.getElementById(b.id);null===c?M(b):K(c,b)}photos=$("#container .photo"),$("#container .photo").each(function(){for(var a=$(this)[0],b=a.getAttribute("id")||"",c=!1,d=0;d<U.length;d++){if(U[d].id==b){c=!0;break}}c&&""!=b||a.parentNode.removeChild(a)}),u(appConfig.locked),m()}function K(a,b){if(b.x&&b.y){var c=p({x:b.x,y:b.y});a.setAttribute("data-x",c.x),a.setAttribute("data-y",c.y)}for(var d in b)"rotation"==d&&a.setAttribute("data-rotation",b[d]),"index"==d&&(a.style.zIndex=b[d]);var e=a.getAttribute("data-x")||0,f=a.getAttribute("data-y")||0,g=a.getAttribute("data-rotation")||0;a.style.transform="translateX("+e+"px) translateY("+f+"px) rotateZ("+g+"deg)"}function L(a){var b=I();return b=P(c()),{x:b.x-a.width/2,y:b.y-a.height/2}}function M(a){var b=a.id,c=document.createElement("div"),d=O(a),e=L(d),f=document.createElement("span");f.classList.add("comment"),f.classList.add("tap-comment"),f.innerHTML=a.comment||"",c.appendChild(f),c.id=b,c.style.width=d.width+"px",c.style.height=d.height+"px";var g=document.createElement("a");g.classList.add("lock"),c.appendChild(g);var h=new Image;h.target=c,h.appended=!1,h.onload=function(){this.target.appendChild(this)},h.onerror=function(){if(console.log("Error loading image..."),appConfig.forcedReload)return appConfig.forcedReload=!1,void saveAppConfig();appConfig.forcedReload=!0,saveAppConfig(),location.reload()},h.src=Q?a.min:a.sourceUrl,c.style.transform="rotateZ("+a.rotation+"deg)",c.style.margin=0,c.style.position="absolute",c.style.top=e.y+"px",c.style.left=e.x+"px",c.classList.add("photo"),c.classList.add("drag-rotate"),c.classList.add("tap-index"),X.appendChild(c),c.setAttribute("data-update","true"),c.setAttribute("data-width",d.width),c.setAttribute("data-height",d.height),K(c,a)}function N(){return{x:$("#container").width()/-2,y:$("#container").height()/-2}}function O(a){var b=a.height>a.width,c=b?T.portrait.width:T.landscape.width,d=b?T.portrait.height:T.landscape.height,e=a.height/a.width,f=Math.min(R*(c/100),a.width),g=f*e,h=S*(d/100);return a.height>h&&(e=a.width/a.height,g=h,f=g*e),{width:f,height:g}}function P(a){return{x:-1*a.x,y:-1*a.y}}$.extend(verge);var Q=!0,R=1920,S=1080,T={portrait:{width:94,height:94},landscape:{width:85,height:85}},U=[],V=[],W=$("#container"),X=$("#container")[0],Y=W.width(),Z=W.height(),_=!1,aa=!1,ba=20;a();$(window).resize(b),b();var ca=$("#controls-menu"),da=$("#lock-button"),ea=($("#add-button"),$("#remove-button")),fa=$("#comment-button");t(!!appConfig.showUI);var ga=c(),ha=ga;appConfig.x&&appConfig.y&&(ha=p({x:appConfig.x,y:appConfig.y})),W.velocity({translateX:ha.x+"px",translateY:ha.y+"px"},0).attr({"data-x":ha.x,"data-y":ha.y}),appConfig.playing&&(appConfig.playing=!1,saveAppConfig()),socket.on("connect",function(){console.log("Connected to ws server."),socket.emit("requestManifest")});socket.on("manifest",function(a){console.log("Got manifest update!"),U=a,imageManifestUpdated=!0,J()}),setTimeout(function(){U.length>0||(console.log("Failed to retrieve manifest from websocket... reverting to ajax!"),$.ajax({url:"manifest.json",success:function(a){console.log("Got AJAX manifest update!"),U=a,imageManifestUpdated=!0,J()}}))},2e3),socket.on("updateItemClient",function(a){console.log("received update from server");for(var b=a.id,c=!1,d=0;d<U.length;d++){var e=U[d];if(e.id==b){c=!0;for(var f in a)e[f]=a[f];break}}if(!c)return!1;var g=document.getElementById(a.id);null===g?M(a):K(g,a.props)}),socket.on("disconnect",function(){console.log("Disconnected from ws server.")}),socket.on("reconnect",function(){console.log("Reconnected with ws server.")}),socket.on("reconnect_error",function(){console.log("Attempting to reconnect with ws server.")}),socket.on("log",function(a){console.log(a)});var ia=!1;interact(".tap-comment").on("tap press",function(a){if(appConfig.locked)return void a.preventDefault();var b=a.currentTarget,c=b.innerHTML,d=prompt("Enter your comment",c),e=null==d?"":d;b.innerHTML=d,console.log(b.parentElement.getAttribute("id")),socket.emit("updateItem",{id:b.parentElement.getAttribute("id"),props:{comment:e}})}),interact(".tap-index").on("tap press",function(a){if(_){return void(confirm("Remove this image?")&&(_=!1,socket.emit("removeImage",{id:a.currentTarget.getAttribute("id")}),F(!1)))}if(aa){var b=a.currentTarget,c=$(b).find("span.comment"),d=c.html(),e=prompt("Enter your comment",d),f=null==e?"":e;return c.html(e),socket.emit("updateItem",{id:b.getAttribute("id"),props:{comment:f}}),aa=!1,void E(!1)}s(a.currentTarget),a.preventDefault()}),interact(".drag").draggable({inertia:!0,autoScroll:!1,onstart:function(a){ia=!0},onmove:n,onend:d}),interact(".drag-rotate").draggable({inertia:!1,autoScroll:!1,onstart:function(a){a.target.classList.add("dragging"),ia=!0},onmove:n,onend:d}).gesturable({onstart:function(a){ia=!0},onmove:f,onend:function(a){ia=!1}});var ja=new Date,ka=ja.getTime(),la=100,ja=new Date,ma=ja.getTime(),na=250,oa=1.25,pa=[];h();var qa,ra,ja=new Date,sa=ja.getTime(),ta=100,ua=15,va=5e3,V=[],wa="",xa=0;Math.clamp=function(a,b,c){return Math.max(b,Math.min(a,c))},$("#container").on("mousewheel",".drag-rotate",function(a){a.da=1.5*a.deltaY;var b=$(a.target).closest(".drag-rotate");a.target=b[0],f(a)}),$("body").hammer().on("pan swipe",function(a){a.preventDefault()}),$("#controls-menu div.hitbox").hammer().on("tap",function(a){a.preventDefault(),appConfig.showUI||t(!0)}),$("ul.controls li a:not(.null)").hammer().on("tap",function(a){var b=$(this);switch(b[0].getAttribute("data-action")){case"play":G(!appConfig.playing);break;case"speed":var c=appConfig.speed,d=parseFloat(prompt("Adjust play speed [0.1-100]",c));if(isNaN(d))return;appConfig.speed=Math.clamp(d,.1,100),saveAppConfig(),appConfig.playing&&c!=d&&(C(),D());break;case"locktoggle":if(appConfig.playing)break;u(!appConfig.locked);break;case"add":a.preventDefault();var f=$(document.createElement("input"));f.attr("id","file-input"),f.attr("type","file"),f.attr("multiple","multiple"),f.on("change",function(a){for(var b=o(H()),c=$(this)[0].files,d=0;d<c.length;d++){var e=c[d];reader=new FileReader,reader.filename=e.name,reader.spawnLocation=b,reader.onload=function(a){socket.emit("addImage",{filename:this.filename,base64:a.target.result,x:this.spawnLocation.x,y:this.spawnLocation.y}),console.log("Sent ["+this.filename+"] to the server!")},reader.readAsDataURL(e)}}),f.trigger("click");break;case"comment":a.preventDefault(),aa?(aa=!1,E(!1)):(aa=!0,E(!0));break;case"remove":a.preventDefault(),_?(_=!1,F(!1)):(_=!0,F(!0));break;case"close":a.preventDefault(),t(!1);break;case"fullscreen":screenfull.isFullscreen?(screenfull.exit(),b.removeClass("active"),e(!0),appConfig.playing||m(!0)):(screenfull.request(),b.removeClass("active").addClass("active"),appConfig.playing||m(!0));break;case"home":appConfig.playing&&(C(),G(!1)),W[0].style.transform="",W.velocity({translateX:N().x+"px",translateY:N().y+"px"},{complete:function(){e(!0),xa=ba}},1e3).attr({"data-x":N().x,"data-y":N().y})}}),Math.radians=function(a){return a*Math.PI/180},Math.degrees=function(a){return 180*a/Math.PI},Math.normalize=function(a){return a%=360,a<0&&(a+=260),a},Math.findAngle=function(a,b){return 180*Math.atan2(b.y-a.y,b.x-a.x)/Math.PI},Math.grid=function(a,b,c){var b=b||1,c=c||1;return{x:Math.round(a.x/b)*b,y:Math.round(a.y/c)*c}}});